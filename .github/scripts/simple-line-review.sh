#!/bin/bash

# ê°„ë‹¨í•œ ë¼ì¸ë³„ ì½”ë“œ ë¦¬ë·° ìŠ¤í¬ë¦½íŠ¸ (jq ì˜ì¡´ì„± ì—†ìŒ)
# GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ PRì— ë¼ì¸ë³„ ì½”ë©˜íŠ¸ ì¶”ê°€

set -e

# ì„¤ì •
PR_NUMBER="${1:-}"
if [ -z "$PR_NUMBER" ]; then
    echo "âŒ ì‚¬ìš©ë²•: $0 <PR_NUMBER>"
    echo "ì˜ˆì‹œ: $0 3"
    exit 1
fi

echo "ğŸ” PR #$PR_NUMBER ë¶„ì„ ì¤‘..."

# ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ê°„ë‹¨í•œ ë°©ë²•)
echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ ë¶„ì„ ì¤‘..."
FILES=$(gh pr view "$PR_NUMBER" --json files --template '{{range .files}}{{.path}}{{"\n"}}{{end}}')

if [ -z "$FILES" ]; then
    echo "âŒ ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
    exit 1
fi

echo "ë³€ê²½ëœ íŒŒì¼ë“¤:"
echo "$FILES" | sed 's/^/  - /'

# ê° íŒŒì¼ë³„ë¡œ ë¶„ì„ ë° ì½”ë©˜íŠ¸ ì¶”ê°€
found_issues=false

for file in $FILES; do
    echo ""
    echo "ğŸ“„ ë¶„ì„ ì¤‘: $file"
    
    if [ ! -f "$file" ]; then
        echo "  âš ï¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ (ì‚­ì œëœ íŒŒì¼)"
        continue
    fi
    
    # íŒŒì¼ í™•ì¥ì í™•ì¸
    extension="${file##*.}"
    line_number=1
    comment_added=false
    
    case "$extension" in
        kt|java)
            echo "  ğŸ” Kotlin/Java íŒŒì¼ ê²€ì‚¬ ì¤‘..."
            
            # í•˜ë“œì½”ë”©ëœ API í‚¤ ê²€ìƒ‰
            if grep -n "apiKey.*=.*\".*\"" "$file" > /dev/null; then
                line_num=$(grep -n "apiKey.*=.*\".*\"" "$file" | head -1 | cut -d: -f1)
                echo "    ğŸ”’ ë¼ì¸ $line_num: í•˜ë“œì½”ë”©ëœ API í‚¤ ë°œê²¬"
                
                # ë‹¨ì¼ ì½”ë©˜íŠ¸ë¡œ ì¶”ê°€
                gh pr comment "$PR_NUMBER" --body "$(cat <<-EOF
## ğŸ”’ ë³´ì•ˆ ì´ìŠˆ - $file:$line_num

**í•˜ë“œì½”ë”©ëœ API í‚¤ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.**

\`\`\`
$(sed -n "${line_num}p" "$file")
\`\`\`

**ê¶Œì¥ ìˆ˜ì •ì‚¬í•­:**
\`\`\`kotlin
// í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
private val apiKey = System.getenv("API_KEY") ?: throw IllegalStateException("API_KEY not set")
\`\`\`

ğŸ¤– Generated by [Claude Code](https://claude.ai/code)
EOF
                )"
                found_issues=true
                comment_added=true
            fi
            
            # SQL ì¸ì ì…˜ ì·¨ì•½ì  ê²€ìƒ‰
            if grep -n "SELECT.*WHERE.*\\\$" "$file" > /dev/null && [ "$comment_added" = false ]; then
                line_num=$(grep -n "SELECT.*WHERE.*\\\$" "$file" | head -1 | cut -d: -f1)
                echo "    âš ï¸ ë¼ì¸ $line_num: SQL ì¸ì ì…˜ ìœ„í—˜"
                
                gh pr comment "$PR_NUMBER" --body "$(cat <<-EOF
## âš ï¸ ë³´ì•ˆ ì·¨ì•½ì  - $file:$line_num

**SQL ì¸ì ì…˜ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.**

\`\`\`
$(sed -n "${line_num}p" "$file")
\`\`\`

**ê¶Œì¥ ìˆ˜ì •ì‚¬í•­:**
\`\`\`kotlin
// PreparedStatement ì‚¬ìš©
val query = "SELECT * FROM users WHERE id = ?"
val preparedStatement = connection.prepareStatement(query)
preparedStatement.setString(1, id)
\`\`\`

ğŸ¤– Generated by [Claude Code](https://claude.ai/code)
EOF
                )"
                found_issues=true
                comment_added=true
            fi
            
            # ì…ë ¥ ê²€ì¦ ëˆ„ë½
            if grep -n "@RequestBody.*String" "$file" > /dev/null && [ "$comment_added" = false ]; then
                line_num=$(grep -n "@RequestBody.*String" "$file" | head -1 | cut -d: -f1)
                echo "    ğŸ’¡ ë¼ì¸ $line_num: ì…ë ¥ ê²€ì¦ ê°œì„  ê¶Œì¥"
                
                gh pr comment "$PR_NUMBER" --body "$(cat <<-EOF
## ğŸ’¡ ê°œì„  ì œì•ˆ - $file:$line_num

**ì…ë ¥ ê²€ì¦ì„ ì¶”ê°€í•˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.**

\`\`\`
$(sed -n "${line_num}p" "$file")
\`\`\`

**ê¶Œì¥ ìˆ˜ì •ì‚¬í•­:**
\`\`\`kotlin
// DTO í´ë˜ìŠ¤ì™€ ê²€ì¦ ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©
@PostMapping
fun createUser(@Valid @RequestBody userData: UserDto): ResponseEntity<String> {
    // ì²˜ë¦¬ ë¡œì§
}
\`\`\`

ğŸ¤– Generated by [Claude Code](https://claude.ai/code)
EOF
                )"
                found_issues=true
                comment_added=true
            fi
            ;;
            
        md)
            echo "  ğŸ“ Markdown íŒŒì¼ ê²€ì‚¬ ì¤‘..."
            
            # TODO í•­ëª© í™•ì¸
            if grep -n "TODO\|FIXME" "$file" > /dev/null; then
                line_num=$(grep -n "TODO\|FIXME" "$file" | head -1 | cut -d: -f1)
                echo "    ğŸ“ ë¼ì¸ $line_num: TODO í•­ëª© ë°œê²¬"
                
                gh pr comment "$PR_NUMBER" --body "$(cat <<-EOF
## ğŸ“ ì•Œë¦¼ - $file:$line_num

**TODO í•­ëª©ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.**

\`\`\`
$(sed -n "${line_num}p" "$file")
\`\`\`

ì™„ë£Œ í›„ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.

ğŸ¤– Generated by [Claude Code](https://claude.ai/code)
EOF
                )"
                found_issues=true
                comment_added=true
            fi
            ;;
            
        yml|yaml)
            echo "  âš™ï¸ YAML íŒŒì¼ ê²€ì‚¬ ì¤‘..."
            
            # ì‹œí¬ë¦¿ ì„¤ì • í™•ì¸ (ê¸ì •ì  í”¼ë“œë°±)
            if grep -n "ANTHROPIC_API_KEY\|secrets\." "$file" > /dev/null; then
                line_num=$(grep -n "ANTHROPIC_API_KEY\|secrets\." "$file" | head -1 | cut -d: -f1)
                echo "    âœ… ë¼ì¸ $line_num: ì¢‹ì€ ì‹œí¬ë¦¿ ê´€ë¦¬"
                
                gh pr comment "$PR_NUMBER" --body "$(cat <<-EOF
## âœ… Good Practice - $file:$line_num

**ì‹œí¬ë¦¿ ê´€ë¦¬ê°€ ì ì ˆíˆ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤!**

\`\`\`
$(sed -n "${line_num}p" "$file")
\`\`\`

GitHub Secretsë¥¼ í†µí•œ ì•ˆì „í•œ ê´€ë¦¬ê°€ í™•ì¸ë©ë‹ˆë‹¤.

ğŸ¤– Generated by [Claude Code](https://claude.ai/code)
EOF
                )"
                found_issues=true
                comment_added=true
            fi
            ;;
    esac
    
    if [ "$comment_added" = false ]; then
        echo "    âœ… ì´ìŠˆ ë°œê²¬ë˜ì§€ ì•ŠìŒ"
    fi
done

# ì „ì²´ ìš”ì•½ ë¦¬ë·° ì¶”ê°€
if [ "$found_issues" = true ]; then
    echo ""
    echo "ğŸ“ ì „ì²´ ìš”ì•½ ë¦¬ë·° ì¶”ê°€ ì¤‘..."
    
    gh pr review "$PR_NUMBER" --comment --body "$(cat <<-EOF
## ğŸ¤– ìë™ ë¼ì¸ë³„ ì½”ë“œ ë¦¬ë·° ì™„ë£Œ

### ğŸ“Š ë¶„ì„ ê²°ê³¼
- ë³€ê²½ëœ íŒŒì¼ ìˆ˜: $(echo "$FILES" | wc -l | tr -d ' ')ê°œ
- ë°œê²¬ëœ ì´ìŠˆ: ìƒì„¸ ì½”ë©˜íŠ¸ì—ì„œ í™•ì¸
- ë¶„ì„ ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')

### ğŸ” ê²€í† ëœ í•­ëª©
- ğŸ”’ ë³´ì•ˆ ì·¨ì•½ì  (API í‚¤, SQL ì¸ì ì…˜)
- âš¡ ì„±ëŠ¥ ë° ì½”ë“œ í’ˆì§ˆ
- ğŸ“ ë¬¸ì„œí™” ë° TODO í•­ëª©
- âš™ï¸ ì„¤ì • íŒŒì¼ ë³´ì•ˆ

### ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„
1. ê° ë¼ì¸ë³„ ì½”ë©˜íŠ¸ í™•ì¸
2. ë³´ì•ˆ ì´ìŠˆ ìš°ì„  ìˆ˜ì •
3. ê°œì„  ì œì•ˆ ê²€í†  ë° ì ìš©

---
ğŸ¤– Generated by [Claude Code](https://claude.ai/code)
EOF
    )"
else
    echo ""
    echo "âœ… ìë™ ë¶„ì„ ì™„ë£Œ - íŠ¹ë³„í•œ ì´ìŠˆ ì—†ìŒ"
    
    gh pr review "$PR_NUMBER" --comment --body "$(cat <<-EOF
## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ì™„ë£Œ

### âœ… ë¶„ì„ ê²°ê³¼
- ë³€ê²½ëœ íŒŒì¼ ìˆ˜: $(echo "$FILES" | wc -l | tr -d ' ')ê°œ
- ìë™ ê²€ì‚¬ì—ì„œ íŠ¹ë³„í•œ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
- ì½”ë“œ í’ˆì§ˆì´ ì–‘í˜¸í•©ë‹ˆë‹¤

### ğŸ“‹ ê²€í† ëœ í•­ëª©
- ğŸ”’ ë³´ì•ˆ ì·¨ì•½ì : ë°œê²¬ë˜ì§€ ì•ŠìŒ
- âš¡ ì„±ëŠ¥ ì´ìŠˆ: ë°œê²¬ë˜ì§€ ì•ŠìŒ  
- ğŸ“ ì½”ë“œ ìŠ¤íƒ€ì¼: ì–‘í˜¸

---
ğŸ¤– Generated by [Claude Code](https://claude.ai/code)
EOF
    )"
fi

echo ""
echo "ğŸ‰ ë¼ì¸ë³„ ìë™ ë¦¬ë·° í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"
echo "ğŸ“‹ PR í˜ì´ì§€ì—ì„œ ìƒì„¸ ì½”ë©˜íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”: https://github.com/$(gh repo view --json owner,name --template '{{.owner.login}}/{{.name}}')/pull/$PR_NUMBER"