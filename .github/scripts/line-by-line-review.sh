#!/bin/bash

# ë¼ì¸ë³„ ì½”ë“œ ë¦¬ë·° ìë™í™” ìŠ¤í¬ë¦½íŠ¸
# GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ PRì— ë¼ì¸ë³„ ì½”ë©˜íŠ¸ ì¶”ê°€

set -e

# ì„¤ì •
PR_NUMBER="${1:-}"
if [ -z "$PR_NUMBER" ]; then
    echo "âŒ ì‚¬ìš©ë²•: $0 <PR_NUMBER>"
    exit 1
fi

# GitHub ì •ë³´ ì¶”ì¶œ (jq ì—†ì´)
REPO_URL=$(gh repo view --json url | grep -o '"url":"[^"]*"' | cut -d'"' -f4)
OWNER=$(echo "$REPO_URL" | cut -d'/' -f4)
REPO=$(echo "$REPO_URL" | cut -d'/' -f5)

echo "ğŸ” PR #$PR_NUMBER ë¶„ì„ ì¤‘..."

# PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
PR_INFO=$(gh pr view "$PR_NUMBER" --json headRefOid,files)
COMMIT_SHA=$(echo "$PR_INFO" | jq -r '.headRefOid')

# ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ë° diff ê°€ì ¸ì˜¤ê¸°
echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ ë¶„ì„ ì¤‘..."
gh pr diff "$PR_NUMBER" > pr_diff.txt

# ë¦¬ë·° ì½”ë©˜íŠ¸ë¥¼ ì €ì¥í•  ì„ì‹œ íŒŒì¼
REVIEW_COMMENTS_FILE="review_comments.json"

# ë¦¬ë·° ì½”ë©˜íŠ¸ JSON ì´ˆê¸°í™”
cat > "$REVIEW_COMMENTS_FILE" << EOF
{
  "commit_id": "$COMMIT_SHA",
  "event": "COMMENT",
  "body": "## ğŸ¤– ìë™ ë¼ì¸ë³„ ì½”ë“œ ë¦¬ë·°\\n\\nì´ ë¦¬ë·°ëŠ” Claude Codeê°€ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.",
  "comments": []
}
EOF

# ì½”ë“œ ë¶„ì„ ë° ë¦¬ë·° ê·œì¹™ ì •ì˜
analyze_code() {
    local file_path="$1"
    local file_content="$2"
    local comments=""
    
    # íŒŒì¼ í™•ì¥ì í™•ì¸
    extension="${file_path##*.}"
    
    case "$extension" in
        kt|java)
            # Kotlin/Java íŒŒì¼ ë¶„ì„
            # í•˜ë“œì½”ë”©ëœ ê°’ ê²€ìƒ‰
            if echo "$file_content" | grep -n "apiKey.*=.*\"" > /dev/null; then
                line_num=$(echo "$file_content" | grep -n "apiKey.*=.*\"" | head -1 | cut -d: -f1)
                comments=$(cat <<-END
{
  "path": "$file_path",
  "line": $line_num,
  "body": "ğŸ”’ **ë³´ì•ˆ ì´ìŠˆ**: í•˜ë“œì½”ë”©ëœ API í‚¤ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\\ní™˜ê²½ ë³€ìˆ˜ë‚˜ ì„¤ì • íŒŒì¼ì„ ì‚¬ìš©í•˜ì„¸ìš”:\\n\`\`\`kotlin\\nprivate val apiKey = System.getenv(\"API_KEY\")\\n\`\`\`\\n\\nğŸ¤– Generated by Claude Code"
}
END
                )
            fi
            
            # SQL ì¸ì ì…˜ ì·¨ì•½ì  ê²€ìƒ‰
            if echo "$file_content" | grep -n "SELECT.*WHERE.*\\\$" > /dev/null; then
                line_num=$(echo "$file_content" | grep -n "SELECT.*WHERE.*\\\$" | head -1 | cut -d: -f1)
                if [ -z "$comments" ]; then
                    comments=$(cat <<-END
{
  "path": "$file_path",
  "line": $line_num,
  "body": "âš ï¸ **ë³´ì•ˆ ì·¨ì•½ì **: SQL ì¸ì ì…˜ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.\\n\\nPreparedStatement ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤:\\n\`\`\`kotlin\\nval query = \"SELECT * FROM users WHERE id = ?\"\\n\`\`\`\\n\\nğŸ¤– Generated by Claude Code"
}
END
                    )
                fi
            fi
            
            # ì…ë ¥ ê²€ì¦ ëˆ„ë½
            if echo "$file_content" | grep -n "@RequestBody.*String" > /dev/null; then
                line_num=$(echo "$file_content" | grep -n "@RequestBody.*String" | head -1 | cut -d: -f1)
                if [ -z "$comments" ]; then
                    comments=$(cat <<-END
{
  "path": "$file_path",
  "line": $line_num,
  "body": "ğŸ’¡ **ê°œì„  ì œì•ˆ**: ì…ë ¥ ê²€ì¦ì„ ì¶”ê°€í•˜ì„¸ìš”.\\n\\nDTO í´ë˜ìŠ¤ì™€ ê²€ì¦ ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš© ê¶Œì¥:\\n\`\`\`kotlin\\n@Valid @RequestBody userData: UserDto\\n\`\`\`\\n\\nğŸ¤– Generated by Claude Code"
}
END
                    )
                fi
            fi
            ;;
            
        md)
            # Markdown íŒŒì¼ ë¶„ì„
            # TODO í•­ëª© í™•ì¸
            if echo "$file_content" | grep -n "TODO\|FIXME" > /dev/null; then
                line_num=$(echo "$file_content" | grep -n "TODO\|FIXME" | head -1 | cut -d: -f1)
                comments=$(cat <<-END
{
  "path": "$file_path",
  "line": $line_num,
  "body": "ğŸ“ **ì•Œë¦¼**: TODO í•­ëª©ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\\nì™„ë£Œ í›„ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.\\n\\nğŸ¤– Generated by Claude Code"
}
END
                )
            fi
            ;;
            
        yml|yaml)
            # YAML íŒŒì¼ ë¶„ì„
            # ë³´ì•ˆ ì„¤ì • í™•ì¸
            if echo "$file_content" | grep -n "ANTHROPIC_API_KEY\|secrets\." > /dev/null; then
                line_num=$(echo "$file_content" | grep -n "ANTHROPIC_API_KEY\|secrets\." | head -1 | cut -d: -f1)
                comments=$(cat <<-END
{
  "path": "$file_path",
  "line": $line_num,
  "body": "âœ… **Good Practice**: ì‹œí¬ë¦¿ ê´€ë¦¬ê°€ ì ì ˆíˆ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\\n\\nGitHub Secretsë¥¼ í†µí•œ ì•ˆì „í•œ ê´€ë¦¬ í™•ì¸ë¨.\\n\\nğŸ¤– Generated by Claude Code"
}
END
                )
            fi
            ;;
    esac
    
    echo "$comments"
}

# ë³€ê²½ëœ íŒŒì¼ë³„ë¡œ ë¶„ì„
echo "ğŸ” íŒŒì¼ë³„ ë¶„ì„ ì‹œì‘..."
COMMENTS_JSON="[]"

# PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
FILES=$(gh pr view "$PR_NUMBER" --json files | jq -r '.files[].path')

for file in $FILES; do
    echo "  ğŸ“„ ë¶„ì„ ì¤‘: $file"
    
    # íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if [ -f "$file" ]; then
        # íŒŒì¼ ë‚´ìš© ì½ê¸°
        file_content=$(cat "$file")
        
        # ì½”ë“œ ë¶„ì„ ì‹¤í–‰
        comment=$(analyze_code "$file" "$file_content")
        
        # ì½”ë©˜íŠ¸ê°€ ìˆìœ¼ë©´ JSONì— ì¶”ê°€
        if [ -n "$comment" ]; then
            # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON ë°°ì—´ì— ì¶”ê°€
            COMMENTS_JSON=$(echo "$COMMENTS_JSON" | jq ". += [$comment]")
            echo "    ğŸ’¬ ë¦¬ë·° ì½”ë©˜íŠ¸ ìƒì„±ë¨"
        fi
    fi
done

# ìµœì¢… ë¦¬ë·° JSON ìƒì„±
jq --argjson comments "$COMMENTS_JSON" '.comments = $comments' "$REVIEW_COMMENTS_FILE" > review_final.json

# ì½”ë©˜íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
COMMENT_COUNT=$(echo "$COMMENTS_JSON" | jq 'length')

if [ "$COMMENT_COUNT" -eq 0 ]; then
    echo "âœ… ìë™ ë¶„ì„ ê²°ê³¼ íŠ¹ë³„í•œ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    
    # ì „ì²´ ë¦¬ë·°ë§Œ ì¶”ê°€
    gh pr review "$PR_NUMBER" --comment --body "$(cat <<-EOF
## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ì™„ë£Œ

### âœ… ë¶„ì„ ê²°ê³¼
- ìë™ ê²€ì‚¬ì—ì„œ íŠ¹ë³„í•œ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
- ì½”ë“œ í’ˆì§ˆì´ ì–‘í˜¸í•©ë‹ˆë‹¤.

### ğŸ“‹ ê²€í†  í•­ëª©
- ğŸ”’ ë³´ì•ˆ ì·¨ì•½ì : ë°œê²¬ë˜ì§€ ì•ŠìŒ
- âš¡ ì„±ëŠ¥ ì´ìŠˆ: ë°œê²¬ë˜ì§€ ì•ŠìŒ  
- ğŸ“ ì½”ë“œ ìŠ¤íƒ€ì¼: ì–‘í˜¸

---
ğŸ¤– Generated by [Claude Code](https://claude.ai/code)
EOF
    )"
else
    echo "ğŸ“ $COMMENT_COUNT ê°œì˜ ë¦¬ë·° ì½”ë©˜íŠ¸ ìƒì„±"
    echo "ğŸš€ GitHub APIë¡œ ë¦¬ë·° ì œì¶œ ì¤‘..."
    
    # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ë·° ì œì¶œ
    gh api \
        --method POST \
        -H "Accept: application/vnd.github+json" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "/repos/$OWNER/$REPO/pulls/$PR_NUMBER/reviews" \
        --input review_final.json
    
    echo "âœ… ë¼ì¸ë³„ ì½”ë“œ ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!"
fi

# ì„ì‹œ íŒŒì¼ ì •ë¦¬
rm -f pr_diff.txt "$REVIEW_COMMENTS_FILE" review_final.json

echo "ğŸ‰ ë¦¬ë·° í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"