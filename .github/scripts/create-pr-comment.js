const fs = require('fs');

async function createPRComment(github, context) {
  try {
    let reviewContent = '';
    try {
      reviewContent = fs.readFileSync('review.txt', 'utf8');
    } catch (e) {
      reviewContent = 'Review file not found or empty';
    }
    
    console.log('Review content length:', reviewContent.length);
    console.log('Review content preview:', reviewContent.substring(0, 200));
    
    // API í‚¤/í¬ë ˆë”§ ë¬¸ì œ ì²´í¬
    const hasApiIssue = reviewContent.includes('API key not set') ||
                       reviewContent.includes('authentication failed') ||
                       reviewContent.includes('insufficient credits') ||
                       reviewContent.includes('command not found') ||
                       reviewContent.length < 10;
                       
    if (hasApiIssue) {
      const errorComment = `## ğŸ¤– Claude Code Review

âŒ **ì„¤ì • ë˜ëŠ” ì‹¤í–‰ ë¬¸ì œ ë°œìƒ**

\`\`\`
${reviewContent.substring(0, 500)}
\`\`\`

**ê°€ëŠ¥í•œ ì›ì¸:**
1. **API í‚¤ ë¯¸ì„¤ì •**: Repository â†’ Settings â†’ Secrets â†’ Actionsì—ì„œ ANTHROPIC_API_KEY í™•ì¸
2. **Claude CLI ì„¤ì¹˜ ë¬¸ì œ**: npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì˜¤ë¥˜
3. **í¬ë ˆë”§ ë¶€ì¡±**: [console.anthropic.com](https://console.anthropic.com)ì—ì„œ ì”ì•¡ í™•ì¸

**í•´ê²° í›„**: PR ì¬ì‹¤í–‰ ë˜ëŠ” ìƒˆ ì»¤ë°‹ í‘¸ì‹œ

---
*Powered by Claude Code*`;

      await github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: errorComment
      });
      return;
    }
    
    // í•œêµ­ì–´ íŒ¨í„´ í™•ì¸
    const hasKorean = reviewContent.includes('ğŸš¨') || 
                    reviewContent.includes('âš ï¸') ||
                    reviewContent.includes('ğŸ’¡') ||
                    /[ê°€-í£]/.test(reviewContent);
    
    // ë¦¬ë·° ê²°ê³¼ ë¶„ì„
    const criticalIssues = (reviewContent.match(/ğŸš¨|CRITICAL|ì‹¬ê°í•œ/gi) || []).length;
    const securityIssues = (reviewContent.match(/ë³´ì•ˆ|security|SQL injection|í•˜ë“œì½”ë”©/gi) || []).length;
    
    // ì „ì²´ ë¦¬ë·°ê°€ ë„ˆë¬´ ê¸¸ë©´ ì¶•ì•½ (GitHub ëŒ“ê¸€ ì œí•œ ê³ ë ¤)
    let displayReview = reviewContent;
    if (reviewContent.length > 2000) {
      displayReview = reviewContent.substring(0, 2000) + '\n\n... (ì „ì²´ ë‚´ìš©ì€ Actions ë¡œê·¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”)';
    }
    
    const successComment = `## ğŸ¤– Claude Code Review

### ğŸ“Š ë¶„ì„ ê²°ê³¼
- **ì–¸ì–´**: ${hasKorean ? 'í•œêµ­ì–´ âœ…' : 'ì˜ì–´ (í•œêµ­ì–´ ë³€í™˜ í•„ìš”)'}
- **ì‹¬ê°í•œ ì´ìŠˆ**: ${criticalIssues}ê°œ ê°ì§€
- **ë³´ì•ˆ ê´€ë ¨**: ${securityIssues}ê°œ í•­ëª©

### ğŸ” ìƒì„¸ ë¦¬ë·° ê²°ê³¼

<details>
<summary><strong>ğŸ“‹ ì „ì²´ ë¦¬ë·° ë‚´ìš© ë³´ê¸° (í´ë¦­)</strong></summary>

\`\`\`
${displayReview}
\`\`\`

</details>

### ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„
1. **ìƒì„¸ ë¡œê·¸**: [GitHub Actions ì‹¤í–‰ ê²°ê³¼](../../actions) í™•ì¸
2. **ì´ìŠˆ ìˆ˜ì •**: ë°œê²¬ëœ ë¬¸ì œì ë“¤ ê°œì„ 
3. **ì¬ê²€í† **: ìˆ˜ì • í›„ ìƒˆ ì»¤ë°‹ìœ¼ë¡œ ì¬ê²€ì¦

---
*Auto-generated by Claude Code Review*`;

    await github.rest.issues.createComment({
      issue_number: context.issue.number,
      owner: context.repo.owner,
      repo: context.repo.repo,
      body: successComment
    });
    
  } catch (error) {
    console.error('Error in comment creation:', error);
    
    // ìµœí›„ì˜ fallback
    const fallbackComment = `## ğŸ¤– Claude Code Review

âš ï¸ **ëŒ“ê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ**

**Error**: ${error.message || 'Unknown error'}

**ë””ë²„ê·¸ ì •ë³´**:
- Error type: ${typeof error}
- Stack: ${error.stack ? error.stack.substring(0, 300) : 'No stack trace'}

**í•´ê²° ë°©ë²•**:
1. [GitHub Actions ë¡œê·¸](../../actions)ì—ì„œ ì „ì²´ ë¦¬ë·° ë‚´ìš© í™•ì¸
2. ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰
3. ì´ìŠˆ ì§€ì† ì‹œ ë¦¬í¬ì§€í† ë¦¬ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜

---
*Claude Code Review Debug*`;
    
    await github.rest.issues.createComment({
      issue_number: context.issue.number,
      owner: context.repo.owner,  
      repo: context.repo.repo,
      body: fallbackComment
    });
  }
}

module.exports = createPRComment;