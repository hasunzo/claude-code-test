name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Claude Code
      run: npm install -g @anthropic-ai/claude-code
        
    - name: Run Claude Review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "ğŸ” Starting Claude Code Review..."
        
        # API í‚¤ì™€ í¬ë ˆë”§ í™•ì¸
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "âŒ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "API key not set" > review.txt
          echo "API key not set" > security.txt
        else
          echo "âœ… API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # Claude Code ì‹¤í–‰ (ë” ìƒì„¸í•œ ì—ëŸ¬ ë¡œê¹…)
          echo "ì‹¤í–‰ì¤‘: claude review-pr"
          claude review-pr > review.txt 2>&1 || echo "Review completed with status: $?"
          
          echo "ì‹¤í–‰ì¤‘: claude check-security" 
          claude check-security > security.txt 2>&1 || echo "Security check completed with status: $?"
          
          # ê²°ê³¼ íŒŒì¼ í™•ì¸
          echo "=== Review Output ==="
          cat review.txt
          echo "=== Security Output ==="
          cat security.txt
        fi
        
    - name: Create PR Comment
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.number }}
      run: |
        # GitHub APIë¥¼ ì§ì ‘ ì‚¬ìš©í•´ì„œ ëŒ“ê¸€ ìƒì„±
        REVIEW_CONTENT=$(cat review.txt 2>/dev/null || echo "Review file not found")
        SECURITY_CONTENT=$(cat security.txt 2>/dev/null || echo "Security file not found")
        
        # API í‚¤/í¬ë ˆë”§ ë¬¸ì œ ì²´í¬
        if echo "$REVIEW_CONTENT" | grep -qi "credit.*low\|invalid.*key\|api.*key.*not.*set"; then
          COMMENT_BODY="## ğŸ¤– Claude Code Review

âŒ **API í‚¤ ë˜ëŠ” í¬ë ˆë”§ ë¬¸ì œ**

í˜„ì¬ ìƒíƒœ: \`$(echo "$REVIEW_CONTENT" | head -1)\`

í•´ê²° ë°©ë²•:
1. **API í‚¤ ì„¤ì •**: Repository â†’ Settings â†’ Secrets â†’ Actions
2. **í¬ë ˆë”§ í™•ì¸**: console.anthropic.comì—ì„œ ì”ì•¡ í™•ì¸
3. **í…ŒìŠ¤íŠ¸**: ì„¤ì • í›„ PR ì¬ì‹¤í–‰

---
*Powered by Claude Code*"
        else
          # ìš”ì•½ëœ ë²„ì „ (ëŒ“ê¸€ ê¸¸ì´ ì œí•œ ê³ ë ¤)
          CRITICAL_COUNT=$(echo "$REVIEW_CONTENT" | grep -c "ğŸ”´\|CRITICAL" || echo "0")
          COMMENT_BODY="## ğŸ¤– Claude Code Review

### ğŸ“Š ë¶„ì„ ì™„ë£Œ
- **ë³´ì•ˆ ì·¨ì•½ì **: ${CRITICAL_COUNT}ê°œ ë°œê²¬
- **ìƒì„¸ ê²°ê³¼**: [Actions ë¡œê·¸](../../actions) í™•ì¸

### ğŸš¨ ì£¼ìš” ë°œê²¬ì‚¬í•­
$(echo "$REVIEW_CONTENT" | grep -A 3 "ğŸ”´ CRITICAL" | head -10)

### ğŸ›¡ï¸ ê¶Œì¥ì‚¬í•­
1. í•˜ë“œì½”ë”©ëœ í¬ë¦¬ë´ì…œ ì¦‰ì‹œ ì œê±°
2. SQL ì¸ì ì…˜ ì·¨ì•½ì  ìˆ˜ì •
3. ì…ë ¥ ê²€ì¦ ë¡œì§ ì¶”ê°€

---
*Powered by Claude Code*"
        fi
        
        # GitHub APIë¡œ ëŒ“ê¸€ ìƒì„± (PAT ì‚¬ìš©)
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
          -d "{\"body\": $(echo "$COMMENT_BODY" | jq -Rs .)}" \
          || echo "Comment creation failed - checking permissions"
