name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Claude Code
      run: npm install -g @anthropic-ai/claude-code
        
    - name: Run Claude Review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        CLAUDE_LANGUAGE: ko-KR
      run: |
        echo "ğŸ” Starting Claude Code Review..."
        
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "âŒ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "API key not set" > review.txt
        else
          echo "âœ… API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # .claude ëª…ë ¹ì–´ ê·œì¹™ ì½ê¸°
          if [ -f ".claude/commands/review-pr.md" ]; then
            echo "ğŸ“‹ .claude ëª…ë ¹ì–´ ê·œì¹™ ë°œê²¬, í•œêµ­ì–´ ë¦¬ë·° ëª¨ë“œë¡œ ì‹¤í–‰"
            echo "ë‹¤ìŒ íŒŒì¼ë“¤ì„ DDD+Hexagonal Architecture ê¸°ì¤€ìœ¼ë¡œ í•œêµ­ì–´ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”:" > prompt.txt
            echo "" >> prompt.txt
            cat .claude/commands/review-pr.md >> prompt.txt
            echo "" >> prompt.txt
            echo "=== ë³€ê²½ëœ íŒŒì¼ë“¤ ===" >> prompt.txt
            git diff --name-only HEAD~1 >> prompt.txt
            echo "" >> prompt.txt
            echo "=== ë³€ê²½ ë‚´ìš© ===" >> prompt.txt
            git diff HEAD~1 >> prompt.txt
            
            claude --prompt-file prompt.txt > review.txt 2>&1 || echo "Review completed with status: $?"
          else
            echo "ì‹¤í–‰ì¤‘: claude review-pr (í•œêµ­ì–´ ëª¨ë“œ)"
            claude review-pr --output-language korean > review.txt 2>&1 || echo "Review completed with status: $?"
          fi
          
          echo "=== Review Output ==="
          cat review.txt
        fi
        
    - name: Create PR Comment
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          try {
            const reviewContent = fs.readFileSync('review.txt', 'utf8');
            
            // API í‚¤/í¬ë ˆë”§ ë¬¸ì œ ì²´í¬
            const hasApiIssue = reviewContent.includes('API key not set') ||
                               reviewContent.includes('authentication failed') ||
                               reviewContent.includes('insufficient credits') ||
                               reviewContent.length < 50; // ë„ˆë¬´ ì§§ì€ ì‘ë‹µì€ ì—ëŸ¬ë¡œ ê°„ì£¼
                               
            if (hasApiIssue) {
              const comment = `## ğŸ¤– Claude Code Review
          
          âŒ **API í‚¤ ë˜ëŠ” í¬ë ˆë”§ ë¬¸ì œ**
          
          \`\`\`
          ${reviewContent.substring(0, 300)}
          \`\`\`
          
          **í•´ê²° ë°©ë²•:**
          1. **API í‚¤ ì„¤ì •**: Repository â†’ Settings â†’ Secrets â†’ Actions
          2. **í¬ë ˆë”§ í™•ì¸**: [console.anthropic.com](https://console.anthropic.com)ì—ì„œ ì”ì•¡ í™•ì¸  
          3. **í…ŒìŠ¤íŠ¸**: ì„¤ì • í›„ PR ì¬ì‹¤í–‰
          
          ---
          *Powered by Claude Code*`;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              return;
            }
            
            // ì‹¤ì œ ë¦¬ë·° ë‚´ìš© íŒŒì‹±
            const lines = reviewContent.split('\n');
            const criticalIssues = reviewContent.match(/âŒ.*|BLOCKING.*|CRITICAL.*|HIGH RISK/gi) || [];
            const securityIssues = reviewContent.match(/Hard-coded.*|SQL injection.*|security.*vulnerability/gi) || [];
            
            // ë¦¬ë·° ë‚´ìš© ìš”ì•½ ì¶”ì¶œ
            let summary = '';
            let recommendations = '';
            let securityRating = '';
            
            // Summary ì„¹ì…˜ ì¶”ì¶œ
            const summaryMatch = reviewContent.match(/### ğŸ“‹ Summary of Changes([\s\S]*?)###/);
            if (summaryMatch) {
              summary = summaryMatch[1].trim().substring(0, 400) + '...';
            }
            
            // Security Rating ì¶”ì¶œ  
            const ratingMatch = reviewContent.match(/Security Rating: (.+)/);
            if (ratingMatch) {
              securityRating = ratingMatch[1];
            }
            
            // ì£¼ìš” ì´ìŠˆë“¤ ì¶”ì¶œ
            const criticalSection = reviewContent.match(/ğŸš¨.*Critical.*|âŒ.*BLOCKING.*|Critical Security Concerns([\s\S]*?)(?=###|$)/i);
            let mainIssues = '';
            if (criticalSection) {
              mainIssues = criticalSection[0].substring(0, 600) + '...';
            }
            
            // ì „ì²´ ë¦¬ë·°ê°€ ë„ˆë¬´ ê¸¸ë©´ ì¶•ì•½
            let fullReview = reviewContent;
            if (reviewContent.length > 1500) {
              fullReview = reviewContent.substring(0, 1500) + '\n\n... (ì „ì²´ ë‚´ìš©ì€ Actions ë¡œê·¸ì—ì„œ í™•ì¸)';
            }
            
            const comment = `## ğŸ¤– Claude Code Review
          
          ### ğŸ“Š ë¶„ì„ ê²°ê³¼
          - **ì‹¬ê°í•œ ì´ìŠˆ**: ${criticalIssues.length}ê°œ ë°œê²¬
          - **ë³´ì•ˆ ë¬¸ì œ**: ${securityIssues.length}ê°œ ë°œê²¬
          - **ë³´ì•ˆ ë“±ê¸‰**: ${securityRating || 'í‰ê°€ ì¤‘'}
          
          ### ğŸ” ìƒì„¸ ë¦¬ë·° ê²°ê³¼
          
          <details>
          <summary><strong>ğŸ“‹ ì „ì²´ ë¦¬ë·° ë‚´ìš© ë³´ê¸°</strong></summary>
          
          \`\`\`
          ${fullReview}
          \`\`\`
          
          </details>
          
          ${mainIssues ? `### ğŸš¨ ì£¼ìš” ë°œê²¬ì‚¬í•­\n${mainIssues}` : ''}
          
          ### ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„
          1. **ìƒì„¸ ê²°ê³¼**: [GitHub Actions ë¡œê·¸](../../../actions) í™•ì¸
          2. **ë³´ì•ˆ ì´ìŠˆ**: ì¦‰ì‹œ ìˆ˜ì • í•„ìš”
          3. **ì½”ë“œ ë¦¬ë·°**: íŒ€ ê²€í†  í›„ ë¨¸ì§€ ê²°ì •
          
          ---
          *Auto-generated by Claude Code Review*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
          } catch (error) {
            console.error('Error creating comment:', error);
            
            // ì—ëŸ¬ ë°œìƒ ì‹œ ì›ë³¸ ë¦¬ë·° ë‚´ìš©ì´ë¼ë„ ë³´ì—¬ì£¼ê¸°
            let fallbackContent = 'Failed to read review content';
            try {
              fallbackContent = fs.readFileSync('review.txt', 'utf8').substring(0, 1000);
            } catch (e) {
              fallbackContent = 'Review file not found';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,  
              repo: context.repo.repo,
              body: `## ğŸ¤– Claude Code Review
          
          âš ï¸ **ëŒ“ê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ**
          
          **Error**: ${error.message}
          
          **Raw Review Content**:
          \`\`\`
          ${fallbackContent}
          \`\`\`
          
          [ì „ì²´ ë¡œê·¸ í™•ì¸](../../../actions)
          
          ---
          *Claude Code Review*`
            });
          }
