name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Claude Code
      run: npm install -g @anthropic-ai/claude-code
        
    - name: Run Claude Review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "ğŸ” Starting Claude Code Review..."
        
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "âŒ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "API key not set" > review.txt
        else
          echo "âœ… API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          echo "ì‹¤í–‰ì¤‘: claude review-pr"
          claude review-pr > review.txt 2>&1 || echo "Review completed with status: $?"
          
          echo "=== Review Output ==="
          cat review.txt
        fi
        
    - name: Create PR Comment
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          try {
            const reviewContent = fs.readFileSync('review.txt', 'utf8');
            
            // API í‚¤/í¬ë ˆë”§ ë¬¸ì œ ì²´í¬
            const hasApiIssue = reviewContent.includes('API key not set') ||
                               reviewContent.includes('invalid') ||
                               (reviewContent.includes('credit') && reviewContent.includes('low'));
                               
            if (hasApiIssue) {
              const comment = `## ğŸ¤– Claude Code Review
          
          âŒ **API í‚¤ ë˜ëŠ” í¬ë ˆë”§ ë¬¸ì œ**
          
          í˜„ì¬ ìƒíƒœ: \`${reviewContent.split('\n')[0]}\`
          
          í•´ê²° ë°©ë²•:
          1. **API í‚¤ ì„¤ì •**: Repository â†’ Settings â†’ Secrets â†’ Actions
          2. **í¬ë ˆë”§ í™•ì¸**: console.anthropic.comì—ì„œ ì”ì•¡ í™•ì¸  
          3. **í…ŒìŠ¤íŠ¸**: ì„¤ì • í›„ PR ì¬ì‹¤í–‰
          
          ---
          *Powered by Claude Code*`;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              return;
            }
            
            // ì •ìƒ ë¦¬ë·° ê²°ê³¼
            const criticalCount = (reviewContent.match(/ğŸ”´|CRITICAL/g) || []).length;
            
            const comment = `## ğŸ¤– Claude Code Review
          
          ### ğŸ“Š ë¶„ì„ ì™„ë£Œ  
          - **ë³´ì•ˆ ì·¨ì•½ì **: ${criticalCount}ê°œ ë°œê²¬
          - **ìƒì„¸ ê²°ê³¼**: [Actions ë¡œê·¸](../../actions) í™•ì¸
          
          ### ğŸš¨ ì£¼ìš” ë°œê²¬ì‚¬í•­
          ${reviewContent.includes('ğŸ”´ CRITICAL') ? 
            (reviewContent.split('ğŸ”´ CRITICAL')[1] || '').substring(0, 500) + '...' : 
            'ì„¸ë¶€ ë‚´ìš©ì€ Actions ë¡œê·¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”'}
          
          ### ğŸ›¡ï¸ ê¶Œì¥ì‚¬í•­
          1. í•˜ë“œì½”ë”©ëœ í¬ë¦¬ë´ì…œ ì¦‰ì‹œ ì œê±°
          2. SQL ì¸ì ì…˜ ì·¨ì•½ì  ìˆ˜ì •  
          3. ì…ë ¥ ê²€ì¦ ë¡œì§ ì¶”ê°€
          
          ---
          *Powered by Claude Code*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
          } catch (error) {
            console.error('Error creating comment:', error);
            
            // ìµœì†Œí•œì˜ ëŒ“ê¸€ì´ë¼ë„ ë‹¬ê¸°
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,  
              repo: context.repo.repo,
              body: `## ğŸ¤– Claude Code Review
          
          âœ… **ë¦¬ë·° ì™„ë£Œ**
          
          ìƒì„¸ ê²°ê³¼ëŠ” [Actions ë¡œê·¸](../../actions)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
          
          Error: ${error.message}`
            });
          }
