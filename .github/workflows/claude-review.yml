name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_LANGUAGE: ko-KR
        run: |
          echo "ðŸ” Starting Claude Code Review..."
          
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âŒ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "API key not set" > review.txt
          else
            echo "âœ… API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
            # .claude ëª…ë ¹ì–´ ê·œì¹™ ì½ê¸°
            if [ -f ".claude/commands/review-pr.md" ]; then
              echo "ðŸ“‹ .claude ëª…ë ¹ì–´ ê·œì¹™ ë°œê²¬, í•œêµ­ì–´ ë¦¬ë·° ëª¨ë“œë¡œ ì‹¤í–‰"
          
              # ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
              CHANGED_FILES=$(git diff --name-only HEAD~1)
              echo "ë³€ê²½ëœ íŒŒì¼ë“¤: $CHANGED_FILES"
          
              # í•œêµ­ì–´ ë¦¬ë·° ëª…ë ¹ì–´ ì‹¤í–‰ (.claude ì»¤ìŠ¤í…€ ëª…ë ¹ì–´ ì‚¬ìš©)
              echo "ì‹¤í–‰ì¤‘: /project:review-pr (í•œêµ­ì–´ ì„¤ì •)"
              CLAUDE_LANGUAGE=ko claude --execute "/project:review-pr" > review.txt 2>&1 || echo "Review completed with status: $?"
          
              # ë¦¬ë·° ê²°ê³¼ì— .claude ê·œì¹™ ì¤€ìˆ˜ ì—¬ë¶€ í™•ì¸ í›„ í•œêµ­ì–´ë¡œ ìž¬í¬ë§·
              if grep -q "English" review.txt || ! grep -q "í•œêµ­ì–´\|Korean\|ðŸš¨\|âš ï¸\|ðŸ’¡" review.txt; then
                echo "ì˜ì–´ ì‘ë‹µ ê°ì§€, í•œêµ­ì–´ë¡œ ìž¬ì²˜ë¦¬ ì¤‘..."
                echo "ë‹¤ìŒì€ PR ë¦¬ë·° ê²°ê³¼ìž…ë‹ˆë‹¤. .claude/commands/review-pr.md ê·œì¹™ì— ë”°ë¼ í•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:" > korean_prompt.txt
                echo "" >> korean_prompt.txt
                echo "=== .claude ë¦¬ë·° ê·œì¹™ ===" >> korean_prompt.txt  
                cat .claude/commands/review-pr.md >> korean_prompt.txt
                echo "" >> korean_prompt.txt
                echo "=== ê¸°ì¡´ ë¦¬ë·° ê²°ê³¼ ===" >> korean_prompt.txt
                cat review.txt >> korean_prompt.txt
                echo "" >> korean_prompt.txt
                echo "=== ë³€ê²½ëœ íŒŒì¼ë“¤ ===" >> korean_prompt.txt
                echo "$CHANGED_FILES" >> korean_prompt.txt
          
                # í‘œì¤€ claude ëª…ë ¹ì–´ë¡œ ìž¬ì²˜ë¦¬
                claude "$(cat korean_prompt.txt)" > review_korean.txt 2>&1 && mv review_korean.txt review.txt
              fi
            else
              echo "ê¸°ë³¸ ë¦¬ë·° ëª¨ë“œë¡œ ì‹¤í–‰ (ì»¤ìŠ¤í…€ ëª…ë ¹ì–´ ì—†ìŒ)"
              echo "ì‹¤í–‰ì¤‘: claude --execute \"ë¦¬ë·°í•´ì£¼ì„¸ìš”\""
              claude --execute "ì´ PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”" > review.txt 2>&1 || echo "Review completed with status: $?"
            fi
          
            echo "=== Review Output ==="
            cat review.txt
          fi

      - name: Create PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const createPRComment = require('./.github/scripts/create-pr-comment.js');
            await createPRComment(github, context);