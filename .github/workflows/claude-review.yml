name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

# GitHub Actions에 PR 댓글 권한 부여
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Claude Code
      run: npm install -g @anthropic-ai/claude-code
        
    - name: Run Claude Review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "🔍 Starting Claude Code Review..."
        
        # API 키 확인
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "❌ ANTHROPIC_API_KEY가 설정되지 않았습니다."
          echo "Invalid API key - not set" > review.txt
          echo "Invalid API key - not set" > security.txt
        else
          echo "✅ API 키가 설정되었습니다."
          
          # Claude Code 실행
          claude review-pr > review.txt 2>&1 || echo "Review completed with warnings"
          claude check-security > security.txt 2>&1 || echo "Security check completed"
        fi
        
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          try {
            const review = fs.readFileSync('review.txt', 'utf8');
            const security = fs.readFileSync('security.txt', 'utf8');
            
            // API 키 문제 체크
            if (review.includes('Invalid API key') || security.includes('Invalid API key')) {
              const comment = `## 🤖 Claude Code Review
              
              ❌ **API 키 설정 필요**
              
              GitHub Secrets에 \`ANTHROPIC_API_KEY\`를 설정해주세요:
              1. Repository → Settings → Secrets and variables → Actions
              2. New repository secret 클릭
              3. Name: \`ANTHROPIC_API_KEY\`
              4. Secret: your-anthropic-api-key
              
              설정 후 PR을 다시 push하거나 Re-run jobs를 클릭해주세요.`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              return;
            }
            
            // 정상 리뷰 결과 댓글
            const comment = `## 🤖 Claude Code Review
            
            ### 📊 PR Review
            \`\`\`
            ${review.slice(0, 1500)}${review.length > 1500 ? '\n...(truncated)' : ''}
            \`\`\`
            
            ### 🛡️ Security Check
            \`\`\`  
            ${security.slice(0, 1500)}${security.length > 1500 ? '\n...(truncated)' : ''}
            \`\`\`
            
            ### 📋 Summary
            - 🔍 **PR Review**: ${review.includes('🚨') ? '❌ Issues Found' : '✅ Looks Good'}
            - 🛡️ **Security**: ${security.includes('Critical') ? '❌ Vulnerabilities' : '✅ No Issues'}
            
            ---
            *Powered by Claude Code & DDD+Hexagonal Architecture Rules*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
          } catch (error) {
            console.error('Error:', error);
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 🤖 Claude Code Review
              
              ❌ 리뷰 실행 중 오류가 발생했습니다.
              
              Error: \`${error.message}\`
              
              [Actions 로그](../../actions)에서 자세한 내용을 확인해주세요.`
            });
          }
