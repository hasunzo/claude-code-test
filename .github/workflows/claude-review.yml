name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_LANGUAGE: ko-KR
        run: |
          echo "🔍 Starting Claude Code Review..."
          
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "❌ ANTHROPIC_API_KEY가 설정되지 않았습니다."
            echo "API key not set" > review.txt
          else
            echo "✅ API 키가 설정되었습니다."
          
            # .claude 명령어 규칙 읽기
            if [ -f ".claude/commands/review-pr.md" ]; then
              echo "📋 .claude 명령어 규칙 발견, 한국어 리뷰 모드로 실행"
          
              # 변경된 파일들 확인
              CHANGED_FILES=$(git diff --name-only HEAD~1)
              echo "변경된 파일들: $CHANGED_FILES"
          
              # 한국어 리뷰 명령어 실행 (.claude 커스텀 명령어 사용)
              echo "실행중: /project:review-pr (한국어 설정)"
              CLAUDE_LANGUAGE=ko claude --execute "/project:review-pr" > review.txt 2>&1 || echo "Review completed with status: $?"
          
              # 리뷰 결과에 .claude 규칙 준수 여부 확인 후 한국어로 재포맷
              if grep -q "English" review.txt || ! grep -q "한국어\|Korean\|🚨\|⚠️\|💡" review.txt; then
                echo "영어 응답 감지, 한국어로 재처리 중..."
                echo "다음은 PR 리뷰 결과입니다. .claude/commands/review-pr.md 규칙에 따라 한국어로 응답해주세요:" > korean_prompt.txt
                echo "" >> korean_prompt.txt
                echo "=== .claude 리뷰 규칙 ===" >> korean_prompt.txt  
                cat .claude/commands/review-pr.md >> korean_prompt.txt
                echo "" >> korean_prompt.txt
                echo "=== 기존 리뷰 결과 ===" >> korean_prompt.txt
                cat review.txt >> korean_prompt.txt
                echo "" >> korean_prompt.txt
                echo "=== 변경된 파일들 ===" >> korean_prompt.txt
                echo "$CHANGED_FILES" >> korean_prompt.txt
          
                # 표준 claude 명령어로 재처리
                claude "$(cat korean_prompt.txt)" > review_korean.txt 2>&1 && mv review_korean.txt review.txt
              fi
            else
              echo "기본 리뷰 모드로 실행 (커스텀 명령어 없음)"
              echo "실행중: claude --execute \"리뷰해주세요\""
              claude --execute "이 PR의 변경사항을 리뷰해주세요" > review.txt 2>&1 || echo "Review completed with status: $?"
            fi
          
            echo "=== Review Output ==="
            cat review.txt
          fi

      - name: Create PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const createPRComment = require('./.github/scripts/create-pr-comment.js');
            await createPRComment(github, context);