name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Claude Code
      run: npm install -g @anthropic-ai/claude-code
        
    - name: Run Claude Review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        CLAUDE_LANGUAGE: ko-KR
      run: |
        echo "ğŸ” Starting Claude Code Review..."
        
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "âŒ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "API key not set" > review.txt
        else
          echo "âœ… API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # .claude ëª…ë ¹ì–´ ê·œì¹™ ì½ê¸°
          if [ -f ".claude/commands/review-pr.md" ]; then
            echo "ğŸ“‹ .claude ëª…ë ¹ì–´ ê·œì¹™ ë°œê²¬, í•œêµ­ì–´ ë¦¬ë·° ëª¨ë“œë¡œ ì‹¤í–‰"
            
            # ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
            CHANGED_FILES=$(git diff --name-only HEAD~1)
            echo "ë³€ê²½ëœ íŒŒì¼ë“¤: $CHANGED_FILES"
            
            # í•œêµ­ì–´ ë¦¬ë·° ëª…ë ¹ì–´ ì‹¤í–‰ (Claude Codeì˜ review-pr ì‚¬ìš©)
            echo "ì‹¤í–‰ì¤‘: claude review-pr (í•œêµ­ì–´ ì„¤ì •)"
            CLAUDE_LANGUAGE=ko claude review-pr > review.txt 2>&1 || echo "Review completed with status: $?"
            
            # ë¦¬ë·° ê²°ê³¼ì— .claude ê·œì¹™ ì¤€ìˆ˜ ì—¬ë¶€ í™•ì¸ í›„ í•œêµ­ì–´ë¡œ ì¬í¬ë§·
            if grep -q "English" review.txt || ! grep -q "í•œêµ­ì–´\|Korean\|ğŸš¨\|âš ï¸\|ğŸ’¡" review.txt; then
              echo "ì˜ì–´ ì‘ë‹µ ê°ì§€, í•œêµ­ì–´ë¡œ ì¬ì²˜ë¦¬ ì¤‘..."
              echo "ë‹¤ìŒì€ PR ë¦¬ë·° ê²°ê³¼ì…ë‹ˆë‹¤. .claude/commands/review-pr.md ê·œì¹™ì— ë”°ë¼ í•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:" > korean_prompt.txt
              echo "" >> korean_prompt.txt
              echo "=== .claude ë¦¬ë·° ê·œì¹™ ===" >> korean_prompt.txt  
              cat .claude/commands/review-pr.md >> korean_prompt.txt
              echo "" >> korean_prompt.txt
              echo "=== ê¸°ì¡´ ë¦¬ë·° ê²°ê³¼ ===" >> korean_prompt.txt
              cat review.txt >> korean_prompt.txt
              echo "" >> korean_prompt.txt
              echo "=== ë³€ê²½ëœ íŒŒì¼ë“¤ ===" >> korean_prompt.txt
              echo "$CHANGED_FILES" >> korean_prompt.txt
              
              # í‘œì¤€ claude ëª…ë ¹ì–´ë¡œ ì¬ì²˜ë¦¬
              claude "$(cat korean_prompt.txt)" > review_korean.txt 2>&1 && mv review_korean.txt review.txt
            fi
          else
            echo "ì‹¤í–‰ì¤‘: claude review-pr"
            claude review-pr > review.txt 2>&1 || echo "Review completed with status: $?"
          fi
          
          echo "=== Review Output ==="
          cat review.txt
        fi
        
    - name: Create PR Comment
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          try {
            let reviewContent = '';
            try {
              reviewContent = fs.readFileSync('review.txt', 'utf8');
            } catch (e) {
              reviewContent = 'Review file not found or empty';
            }
            
            console.log('Review content length:', reviewContent.length);
            console.log('Review content preview:', reviewContent.substring(0, 200));
            
            // API í‚¤/í¬ë ˆë”§ ë¬¸ì œ ì²´í¬
            const hasApiIssue = reviewContent.includes('API key not set') ||
                               reviewContent.includes('authentication failed') ||
                               reviewContent.includes('insufficient credits') ||
                               reviewContent.includes('command not found') ||
                               reviewContent.length < 10;
                               
            if (hasApiIssue) {
              const errorComment = `## ğŸ¤– Claude Code Review
          
          âŒ **ì„¤ì • ë˜ëŠ” ì‹¤í–‰ ë¬¸ì œ ë°œìƒ**
          
          \`\`\`
          ${reviewContent.substring(0, 500)}
          \`\`\`
          
          **ê°€ëŠ¥í•œ ì›ì¸:**
          1. **API í‚¤ ë¯¸ì„¤ì •**: Repository â†’ Settings â†’ Secrets â†’ Actionsì—ì„œ ANTHROPIC_API_KEY í™•ì¸
          2. **Claude CLI ì„¤ì¹˜ ë¬¸ì œ**: npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì˜¤ë¥˜
          3. **í¬ë ˆë”§ ë¶€ì¡±**: [console.anthropic.com](https://console.anthropic.com)ì—ì„œ ì”ì•¡ í™•ì¸
          
          **í•´ê²° í›„**: PR ì¬ì‹¤í–‰ ë˜ëŠ” ìƒˆ ì»¤ë°‹ í‘¸ì‹œ
          
          ---
          *Powered by Claude Code*`;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: errorComment
              });
              return;
            }
            
            // í•œêµ­ì–´ íŒ¨í„´ í™•ì¸
            const hasKorean = reviewContent.includes('ğŸš¨') || 
                            reviewContent.includes('âš ï¸') ||
                            reviewContent.includes('ğŸ’¡') ||
                            /[ê°€-í£]/.test(reviewContent);
            
            // ë¦¬ë·° ê²°ê³¼ ë¶„ì„
            const criticalIssues = (reviewContent.match(/ğŸš¨|CRITICAL|ì‹¬ê°í•œ/gi) || []).length;
            const securityIssues = (reviewContent.match(/ë³´ì•ˆ|security|SQL injection|í•˜ë“œì½”ë”©/gi) || []).length;
            
            // ì „ì²´ ë¦¬ë·°ê°€ ë„ˆë¬´ ê¸¸ë©´ ì¶•ì•½ (GitHub ëŒ“ê¸€ ì œí•œ ê³ ë ¤)
            let displayReview = reviewContent;
            if (reviewContent.length > 2000) {
              displayReview = reviewContent.substring(0, 2000) + '\n\n... (ì „ì²´ ë‚´ìš©ì€ Actions ë¡œê·¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”)';
            }
            
            const successComment = `## ğŸ¤– Claude Code Review
          
          ### ğŸ“Š ë¶„ì„ ê²°ê³¼
          - **ì–¸ì–´**: ${hasKorean ? 'í•œêµ­ì–´ âœ…' : 'ì˜ì–´ (í•œêµ­ì–´ ë³€í™˜ í•„ìš”)'}
          - **ì‹¬ê°í•œ ì´ìŠˆ**: ${criticalIssues}ê°œ ê°ì§€
          - **ë³´ì•ˆ ê´€ë ¨**: ${securityIssues}ê°œ í•­ëª©
          
          ### ğŸ” ìƒì„¸ ë¦¬ë·° ê²°ê³¼
          
          <details>
          <summary><strong>ğŸ“‹ ì „ì²´ ë¦¬ë·° ë‚´ìš© ë³´ê¸° (í´ë¦­)</strong></summary>
          
          \`\`\`
          ${displayReview}
          \`\`\`
          
          </details>
          
          ### ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„
          1. **ìƒì„¸ ë¡œê·¸**: [GitHub Actions ì‹¤í–‰ ê²°ê³¼](../../actions) í™•ì¸
          2. **ì´ìŠˆ ìˆ˜ì •**: ë°œê²¬ëœ ë¬¸ì œì ë“¤ ê°œì„ 
          3. **ì¬ê²€í† **: ìˆ˜ì • í›„ ìƒˆ ì»¤ë°‹ìœ¼ë¡œ ì¬ê²€ì¦
          
          ---
          *Auto-generated by Claude Code Review*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: successComment
            });
            
          } catch (error) {
            console.error('Error in comment creation:', error);
            
            // ìµœí›„ì˜ fallback
            const fallbackComment = `## ğŸ¤– Claude Code Review
          
          âš ï¸ **ëŒ“ê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ**
          
          **Error**: ${error.message || 'Unknown error'}
          
          **ë””ë²„ê·¸ ì •ë³´**:
          - Error type: ${typeof error}
          - Stack: ${error.stack ? error.stack.substring(0, 300) : 'No stack trace'}
          
          **í•´ê²° ë°©ë²•**:
          1. [GitHub Actions ë¡œê·¸](../../actions)ì—ì„œ ì „ì²´ ë¦¬ë·° ë‚´ìš© í™•ì¸
          2. ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰
          3. ì´ìŠˆ ì§€ì† ì‹œ ë¦¬í¬ì§€í† ë¦¬ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜
          
          ---
          *Claude Code Review Debug*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,  
              repo: context.repo.repo,
              body: fallbackComment
            });
          }
