name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Claude Code
      run: npm install -g @anthropic-ai/claude-code
        
    - name: Run Claude Review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "🔍 Starting Claude Code Review..."
        
        # API 키와 크레딧 확인
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "❌ ANTHROPIC_API_KEY가 설정되지 않았습니다."
          echo "API key not set" > review.txt
          echo "API key not set" > security.txt
        else
          echo "✅ API 키가 설정되었습니다."
          
          # Claude Code 실행 (더 상세한 에러 로깅)
          echo "실행중: claude review-pr"
          claude review-pr > review.txt 2>&1 || echo "Review completed with status: $?"
          
          echo "실행중: claude check-security" 
          claude check-security > security.txt 2>&1 || echo "Security check completed with status: $?"
          
          # 결과 파일 확인
          echo "=== Review Output ==="
          cat review.txt
          echo "=== Security Output ==="
          cat security.txt
        fi
        
    - name: Create PR Comment
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.number }}
      run: |
        # GitHub API를 직접 사용해서 댓글 생성
        REVIEW_CONTENT=$(cat review.txt 2>/dev/null || echo "Review file not found")
        SECURITY_CONTENT=$(cat security.txt 2>/dev/null || echo "Security file not found")
        
        # API 키/크레딧 문제 체크
        if echo "$REVIEW_CONTENT" | grep -qi "credit.*low\|invalid.*key\|api.*key.*not.*set"; then
          COMMENT_BODY="## 🤖 Claude Code Review

❌ **API 키 또는 크레딧 문제**

현재 상태: \`$(echo "$REVIEW_CONTENT" | head -1)\`

해결 방법:
1. **API 키 설정**: Repository → Settings → Secrets → Actions
2. **크레딧 확인**: console.anthropic.com에서 잔액 확인
3. **테스트**: 설정 후 PR 재실행

---
*Powered by Claude Code*"
        else
          # 요약된 버전 (댓글 길이 제한 고려)
          CRITICAL_COUNT=$(echo "$REVIEW_CONTENT" | grep -c "🔴\|CRITICAL" || echo "0")
          COMMENT_BODY="## 🤖 Claude Code Review

### 📊 분석 완료
- **보안 취약점**: ${CRITICAL_COUNT}개 발견
- **상세 결과**: [Actions 로그](../../actions) 확인

### 🚨 주요 발견사항
$(echo "$REVIEW_CONTENT" | grep -A 3 "🔴 CRITICAL" | head -10)

### 🛡️ 권장사항
1. 하드코딩된 크리덴셜 즉시 제거
2. SQL 인젝션 취약점 수정
3. 입력 검증 로직 추가

---
*Powered by Claude Code*"
        fi
        
        # GitHub API로 댓글 생성 (PAT 사용)
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
          -d "{\"body\": $(echo "$COMMENT_BODY" | jq -Rs .)}" \
          || echo "Comment creation failed - checking permissions"
