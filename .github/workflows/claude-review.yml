name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

# GitHub Actionsì— PR ëŒ“ê¸€ ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Claude Code
      run: npm install -g @anthropic-ai/claude-code
        
    - name: Run Claude Review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "ğŸ” Starting Claude Code Review..."
        
        # API í‚¤ í™•ì¸
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "âŒ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "Invalid API key - not set" > review.txt
          echo "Invalid API key - not set" > security.txt
        else
          echo "âœ… API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # Claude Code ì‹¤í–‰
          claude review-pr > review.txt 2>&1 || echo "Review completed with warnings"
          claude check-security > security.txt 2>&1 || echo "Security check completed"
        fi
        
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          try {
            const review = fs.readFileSync('review.txt', 'utf8');
            const security = fs.readFileSync('security.txt', 'utf8');
            
            // API í‚¤ ë¬¸ì œ ì²´í¬
            if (review.includes('Invalid API key') || security.includes('Invalid API key')) {
              const comment = `## ğŸ¤– Claude Code Review
              
              âŒ **API í‚¤ ì„¤ì • í•„ìš”**
              
              GitHub Secretsì— \`ANTHROPIC_API_KEY\`ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”:
              1. Repository â†’ Settings â†’ Secrets and variables â†’ Actions
              2. New repository secret í´ë¦­
              3. Name: \`ANTHROPIC_API_KEY\`
              4. Secret: your-anthropic-api-key
              
              ì„¤ì • í›„ PRì„ ë‹¤ì‹œ pushí•˜ê±°ë‚˜ Re-run jobsë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              return;
            }
            
            // ì •ìƒ ë¦¬ë·° ê²°ê³¼ ëŒ“ê¸€
            const comment = `## ğŸ¤– Claude Code Review
            
            ### ğŸ“Š PR Review
            \`\`\`
            ${review.slice(0, 1500)}${review.length > 1500 ? '\n...(truncated)' : ''}
            \`\`\`
            
            ### ğŸ›¡ï¸ Security Check
            \`\`\`  
            ${security.slice(0, 1500)}${security.length > 1500 ? '\n...(truncated)' : ''}
            \`\`\`
            
            ### ğŸ“‹ Summary
            - ğŸ” **PR Review**: ${review.includes('ğŸš¨') ? 'âŒ Issues Found' : 'âœ… Looks Good'}
            - ğŸ›¡ï¸ **Security**: ${security.includes('Critical') ? 'âŒ Vulnerabilities' : 'âœ… No Issues'}
            
            ---
            *Powered by Claude Code & DDD+Hexagonal Architecture Rules*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
          } catch (error) {
            console.error('Error:', error);
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Claude Code Review
              
              âŒ ë¦¬ë·° ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
              
              Error: \`${error.message}\`
              
              [Actions ë¡œê·¸](../../actions)ì—ì„œ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`
            });
          }
